import { merge } from 'monocart-reporter';
import { globSync } from 'glob';

const run = async () => {
  try {
    // ‚úÖ Now read from unzipped all-artifacts location
    const files = globSync('../all-artifacts/Monocart-*/index.json');

    console.log(`üß© Found ${files.length} report(s) to merge`);
    if (files.length === 0) {
      throw new Error('No valid Monocart report files found.');
    }

    await merge({
      files,
      output: '../merged-report'
    });

    console.log('‚úÖ Merged report created at ../merged-report');
  } catch (error) {
    console.error('‚ùå Merge failed:', error);
    process.exit(1);
  }
};

run();



88888888888888888888888888888888888888888888888888888888888888888


    # ‚úÖ Download Final-Combined-Report artifact from aggregate job
    - name: Download Final Combined Artifact Zip
      uses: actions/download-artifact@v4
      with:
        name: Final-Combined-Report
        path: extracted

    # ‚úÖ Unzip Final-Report.zip to get all Monocart artifacts
    - name: Unzip combined report
      run: |
        unzip extracted/Final-Report.zip -d all-artifacts

    - name: Cache npm dependencies
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-npm-cache

    - name: Set npm registry to Cloudflare mirror (avoid E503)
      run: npm config set registry https://registry.npmmirror.com/

    - name: Install dependencies
      run: npm ci
      working-directory: ./Playwright-Automation

    # ‚úÖ Merge valid Monocart reports from unzipped directory
    - name: Merge Monocart reports using monocart-reporter
      run: node merge-monocart.mjs
      working-directory: ./Playwright-Automation

    - name: Debug: List merged report directory
      run: |
        echo "Checking contents of merged-report:"
        ls -R merged-report || echo "merged-report folder not found"

    - name: Upload merged report
      uses: actions/upload-artifact@v4
      with:
        name: merged-report
        path: merged-report
